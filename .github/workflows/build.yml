name: build

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        ghidra:
          - version: "12.0.3"
            tag: "Ghidra_12.0.3_build"
            date: "20260210"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Download Ghidra
        run: |
          wget -q "https://github.com/NationalSecurityAgency/ghidra/releases/download/${{ matrix.ghidra.tag }}/ghidra_${{ matrix.ghidra.version }}_PUBLIC_${{ matrix.ghidra.date }}.zip" -O /tmp/ghidra.zip
          unzip -q /tmp/ghidra.zip -d /tmp/ghidra

      - name: Build extension
        run: gradle -PGHIDRA_INSTALL_DIR=/tmp/ghidra/ghidra_${{ matrix.ghidra.version }}_PUBLIC buildExtension

      - name: Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/*.zip
          file_glob: true
          tag: ${{ github.ref }}
